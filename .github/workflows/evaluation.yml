name: CS7IS3 Assignment 2 - Search Engine Evaluation
on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fetch Dataset (Google Drive)
        run: |
          echo "ðŸ“¦ Fetching dataset (if missing)..."
          if [ -d "Assignment Two" ]; then
            echo "âœ… Dataset directory already present"
          else
            echo "â¬‡ï¸ Downloading dataset from Google Drive..."
            python -m pip install --quiet --no-input gdown
            gdown --fuzzy "https://drive.google.com/file/d/17KpMCaE34eLvdiTINqj1lmxSBSu8BtDP/view" -O assignment-two.zip

            echo "Extracting dataset..."
            tmpdir=$(mktemp -d)
            unzip -q assignment-two.zip -d "$tmpdir"

            if [ -d "$tmpdir/Assignment Two" ]; then
              rm -rf "Assignment Two"
              mv "$tmpdir/Assignment Two" "Assignment Two"
            else
              mkdir -p "Assignment Two"
              mv "$tmpdir"/* "Assignment Two"/ 2>/dev/null || true
            fi

            rm -rf "$tmpdir" assignment-two.zip
            echo "âœ… Dataset ready in 'Assignment Two'"
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and Test Search Engine
        run: |
          cd assignment-two-group-12

          echo "=== CS7IS3 Assignment 2 - Search Engine Test ==="
          
          # Check project structure
          echo "ðŸ“‹ Checking project structure..."
          if [ ! -f "pom.xml" ]; then
            echo "âŒ No Maven project found"
            exit 1
          fi
          echo "âœ… Found Maven project"
          
          if [ ! -d "src/main/java" ]; then
            echo "âŒ No Java source code found"
            exit 1
          fi
          echo "âœ… Found Java source code"
          
          if [ ! -f "topics" ]; then
            echo "âŒ No topics file found"
            exit 1
          fi
          echo "âœ… Found topics file"
          
          if [ ! -d "Assignment Two" ]; then
            echo "âŒ No dataset found"
            exit 1
          fi
          echo "âœ… Found dataset directory"
          
          # Build project
          echo "ðŸ”¨ Building project..."
          mvn clean package -q
          echo "âœ… Build completed successfully"

          echo "ðŸ“ Contents of target/:"
          ls -l target
          
          # Create directories
          mkdir -p index runs out
          
          # Run search engine
          echo "ðŸš€ Running search engine..."
          echo "ðŸ“š Indexing documents..."
          java -jar target/cs7is3-search-1.0.0.jar index --docs "Assignment Two" --index index
          
          echo "ðŸ” Searching topics..."
          java -jar target/cs7is3-search-1.0.0.jar search --index index --topics topics --output runs/student.run --numDocs 1000
          
          echo "âœ… Search completed successfully"
          
      - name: Evaluate Results
        run: |
          cd assignment-two-group-12
          echo "ðŸ“ˆ Evaluating results..."
          python3 ../tools/evaluate.py out/qrels.demo.txt runs/student.run --out_csv out/standings.csv --out_md out/standings.md
          echo "âœ… Evaluation completed"

      - name: Display Results
        run: |
          cd assignment-two-group-12
          echo "=== SEARCH ENGINE EVALUATION RESULTS ==="
          if [ -f "out/standings.md" ]; then
            echo "ðŸ“Š Performance Metrics:"
            cat out/standings.md
            echo ""
            echo "ðŸ“ˆ Detailed Results:"
            if [ -f "out/standings.csv" ]; then
              cat out/standings.csv
            fi
          else
            echo "âŒ No evaluation results found"
          fi

      - name: Publish Summary
        id: summary
        run: |
          cd assignment-two-group-12
          echo "## ðŸ” CS7IS3 Assignment 2 - Search Engine Evaluation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.md" ]; then
            cat out/standings.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No evaluation results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Key Metrics:" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.csv" ]; then
            best=$(tail -n +2 out/standings.csv | head -n1)
            IFS=',' read -r rank run MAP P20 nDCG <<< "$best"
            echo "- **MAP (Mean Average Precision)**: $MAP" >> $GITHUB_STEP_SUMMARY
            echo "- **P@20 (Precision at 20)**: $P20" >> $GITHUB_STEP_SUMMARY
            echo "- **nDCG@20 (Normalized DCG at 20)**: $nDCG" >> $GITHUB_STEP_SUMMARY
            echo "map=$MAP" >> $GITHUB_OUTPUT
            echo "p20=$P20" >> $GITHUB_OUTPUT
            echo "ndcg20=$nDCG" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: search-engine-evaluation-results
          path: |
            out/standings.csv
            out/standings.md
            runs/student.run
            out/qrels.demo.txt
