name: CS7IS3 Assignment 2 - Search Engine Evaluation
on:
  push:
  pull_request:

jobs:
  test:
    runs-on: self-hosted
    env:
    #  LEADERBOARD_API_URL: ${{ secrets.LEADERBOARD_API_URL }}
    #  LEADERBOARD_API_TOKEN: ${{ secrets.LEADERBOARD_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and Test Search Engine
        run: |
          echo "=== CS7IS3 Assignment 2 - Search Engine Test ==="
          
          # Check project structure
          echo "üìã Checking project structure..."
          if [ ! -f "pom.xml" ]; then
            echo "‚ùå No Maven project found"
            exit 1
          fi
          echo "‚úÖ Found Maven project"
          
          if [ ! -d "src/main/java" ]; then
            echo "‚ùå No Java source code found"
            exit 1
          fi
          echo "‚úÖ Found Java source code"
          
          if [ ! -f "topics" ]; then
            echo "‚ùå No topics file found"
            exit 1
          fi
          echo "‚úÖ Found topics file"
          
          if [ ! -d "Assignment Two" ]; then
            echo "‚ùå No dataset found"
            exit 1
          fi
          echo "‚úÖ Found dataset directory"
          
          # Build project
          echo "üî® Building project..."
          mvn clean package -q
          echo "‚úÖ Build completed successfully"
          
          # Create directories
          mkdir -p index runs out
          
          # Run search engine
          echo "üöÄ Running search engine..."
          echo "üìö Indexing documents..."
          java -jar target/cs7is3-search-1.0.0.jar index --docs "Assignment Two" --index index
          
          echo "üîç Searching topics..."
          java -jar target/cs7is3-search-1.0.0.jar search --index index --topics topics --output runs/student.run --numDocs 1000
          
          echo "‚úÖ Search completed successfully"

      - name: Evaluate Results
        run: |
          echo "üìà Evaluating results..."
          python3 tools/evaluate.py qrels.assignment2.part1 runs/student.run --out_csv out/standings.csv --out_md out/standings.md
          echo "‚úÖ Evaluation completed"

      - name: Display Results
        run: |
          echo "=== SEARCH ENGINE EVALUATION RESULTS ==="
          if [ -f "out/standings.md" ]; then
            echo "üìä Performance Metrics:"
            cat out/standings.md
            echo ""
            echo "üìà Detailed Results:"
            if [ -f "out/standings.csv" ]; then
              cat out/standings.csv
            fi
          else
            echo "‚ùå No evaluation results found"
          fi

      - name: Publish Summary
        run: |
          echo "## üîç CS7IS3 Assignment 2 - Search Engine Evaluation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Performance Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.md" ]; then
            cat out/standings.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No evaluation results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Key Metrics:" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.csv" ]; then
            best=$(tail -n +2 out/standings.csv | head -n1)
            IFS=',' read -r rank run MAP P5 P20 nDCG <<< "$best"
            echo "- **MAP (Mean Average Precision)**: $MAP" >> $GITHUB_STEP_SUMMARY
            echo "- **P@5 (Precision at 5)**: $P5" >> $GITHUB_STEP_SUMMARY
            echo "- **P@20 (Precision at 20)**: $P20" >> $GITHUB_STEP_SUMMARY
            echo "- **nDCG@20 (Normalized DCG at 20)**: $nDCG" >> $GITHUB_STEP_SUMMARY
            echo "map=$MAP" >> $GITHUB_OUTPUT
            echo "p5=$P5" >> $GITHUB_OUTPUT
            echo "p20=$P20" >> $GITHUB_OUTPUT
            echo "ndcg20=$nDCG" >> $GITHUB_OUTPUT
          fi
        id: summary

      - name: Submit metrics to leaderboard
        if: ${{ success() && env.LEADERBOARD_API_URL != '' && env.LEADERBOARD_API_TOKEN != '' }}
        env:
          MAP_VALUE: ${{ steps.summary.outputs.map }}
          P5_VALUE: ${{ steps.summary.outputs.p5 }}
          P20_VALUE: ${{ steps.summary.outputs.p20 }}
          NDCG_VALUE: ${{ steps.summary.outputs.ndcg20 }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.actor }}
          TEAM_NAME: ${{ secrets.TEAM_NAME }}
          TEAM_MEMBERS: ${{ secrets.TEAM_MEMBERS }}
          LAST_COMMIT_RAW: ${{ github.event.head_commit.timestamp || github.event.repository.pushed_at || github.run_started_at }}
        run: |
          # Use TEAM_NAME secret if set, otherwise fall back to repo name
          if [ -n "$TEAM_NAME" ]; then
            TEAM="$TEAM_NAME"
          else
            TEAM="${REPO#*/}"
          fi
          STUDENT_ID="$TEAM"
          # Use TEAM_MEMBERS secret if set, otherwise fall back to GitHub actor
          if [ -n "$TEAM_MEMBERS" ]; then
            STUDENT_NAME="$TEAM_MEMBERS"
          else
            STUDENT_NAME="${ACTOR}"
          fi
          LAST_COMMIT="${LAST_COMMIT_RAW}"
          if [ -z "$LAST_COMMIT" ]; then
            LAST_COMMIT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          fi
          # Remove trailing slash from URL if present
          API_URL="${LEADERBOARD_API_URL%/}"
          echo "üì§ Submitting metrics to leaderboard..."
          echo "URL: ${API_URL}/api/results"
          response=$(curl -sSfL -w "\n%{http_code}" -X POST "${API_URL}/api/results" \
            -H "Authorization: Bearer ${LEADERBOARD_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
                  --arg student_id "$STUDENT_ID" \
                  --arg student_name "$STUDENT_NAME" \
                  --arg team "$TEAM" \
                  --arg repo "$REPO" \
                  --arg run_id "$RUN_ID" \
                  --arg last_commit "$LAST_COMMIT" \
                  --argjson map "${MAP_VALUE:-0}" \
                  --argjson p5 "${P5_VALUE:-0}" \
                  --argjson p20 "${P20_VALUE:-0}" \
                  --argjson ndcg "${NDCG_VALUE:-0}" \
                  '{student_id:$student_id, student_name:$student_name, team:$team, repo:$repo, run_id:$run_id, last_commit:$last_commit, map:$map, p5:$p5, p20:$p20, ndcg:$ndcg}')")
          http_code=$(echo "$response" | tail -n 1)
          body=$(echo "$response" | sed '$d')
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Successfully submitted metrics to leaderboard!"
          elif [ "$http_code" -eq 401 ]; then
            echo "‚ùå Unauthorized - Check your LEADERBOARD_API_TOKEN"
            exit 1
          elif [ "$http_code" -eq 404 ]; then
            echo "‚ùå Not Found - Check your LEADERBOARD_API_URL"
            exit 1
          elif [ "$http_code" -eq 400 ]; then
            echo "‚ùå Bad Request - Check the payload format"
            exit 1
          else
            echo "‚ùå Error - HTTP $http_code"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: search-engine-evaluation-results
          path: |
            out/standings.csv
            out/standings.md
            runs/student.run

