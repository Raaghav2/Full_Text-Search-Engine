name: CS7IS3 Assignment 2 - Search Engine Evaluation
on:
  push:
  pull_request:

jobs:
  test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and Test Search Engine
        run: |
          echo "=== CS7IS3 Assignment 2 - Search Engine Test ==="
          
          # Check project structure
          echo "ðŸ“‹ Checking project structure..."
          if [ ! -f "pom.xml" ]; then
            echo "âŒ No Maven project found"
            exit 1
          fi
          echo "âœ… Found Maven project"
          
          if [ ! -d "src/main/java" ]; then
            echo "âŒ No Java source code found"
            exit 1
          fi
          echo "âœ… Found Java source code"
          
          if [ ! -f "topics" ]; then
            echo "âŒ No topics file found"
            exit 1
          fi
          echo "âœ… Found topics file"
          
          if [ ! -d "Assignment Two" ]; then
            echo "âŒ No dataset found"
            exit 1
          fi
          echo "âœ… Found dataset directory"
          
          # Build project
          echo "ðŸ”¨ Building project..."
          mvn clean package -q
          echo "âœ… Build completed successfully"
          
          # Create directories
          mkdir -p index runs out
          
          # Run search engine
          echo "ðŸš€ Running search engine..."
          echo "ðŸ“š Indexing documents..."
          java -jar target/cs7is3-search-1.0.0.jar index --docs "Assignment Two" --index index
          
          echo "ðŸ” Searching topics..."
          java -jar target/cs7is3-search-1.0.0.jar search --index index --topics topics --output runs/student.run --numDocs 1000
          
          echo "âœ… Search completed successfully"

      - name: Evaluate Results
        run: |
          echo "ðŸ“ˆ Evaluating results..."
          python3 tools/evaluate.py qrels.assignment2.part1 runs/student.run --out_csv out/standings.csv --out_md out/standings.md
          echo "âœ… Evaluation completed"

      - name: Display Results
        run: |
          echo "=== SEARCH ENGINE EVALUATION RESULTS ==="
          if [ -f "out/standings.md" ]; then
            echo "ðŸ“Š Performance Metrics:"
            cat out/standings.md
            echo ""
            echo "ðŸ“ˆ Detailed Results:"
            if [ -f "out/standings.csv" ]; then
              cat out/standings.csv
            fi
          else
            echo "âŒ No evaluation results found"
          fi

      - name: Publish Summary
        run: |
          echo "## ðŸ” CS7IS3 Assignment 2 - Search Engine Evaluation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.md" ]; then
            cat out/standings.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No evaluation results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Key Metrics:" >> $GITHUB_STEP_SUMMARY
          if [ -f "out/standings.csv" ]; then
            best=$(tail -n +2 out/standings.csv | head -n1)
            IFS=',' read -r rank run MAP P5 P20 nDCG <<< "$best"
            echo "- **MAP (Mean Average Precision)**: $MAP" >> $GITHUB_STEP_SUMMARY
            echo "- **P@5 (Precision at 5)**: $P5" >> $GITHUB_STEP_SUMMARY
            echo "- **P@20 (Precision at 20)**: $P20" >> $GITHUB_STEP_SUMMARY
            echo "- **nDCG@20 (Normalized DCG at 20)**: $nDCG" >> $GITHUB_STEP_SUMMARY
          fi
        id: summary

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: search-engine-evaluation-results
          path: |
            out/standings.csv
            out/standings.md
            runs/student.run
